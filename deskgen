#!/usr/bin/env python3

import sys, os
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QLineEdit, QPushButton,
    QFileDialog, QLabel, QMessageBox, QCheckBox, QComboBox
)
from PyQt6.QtGui import QIcon

CATEGORIES = [
    "Utility", "Development", "Education", "Game",
    "Graphics", "Network", "Office", "Science",
    "Settings", "System", "AudioVideo"
]

class DesktopGenerator(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Universal .desktop Generator")
        self.setFixedSize(400, 300)

        layout = QVBoxLayout()

        # Name
        self.name = QLineEdit(); self.name.setPlaceholderText("App Name")
        layout.addWidget(self.name)

        # Exec path + browse (inline)
        exec_row = QHBoxLayout()
        self.exec_path = QLineEdit(); self.exec_path.setPlaceholderText("Command/Executable")
        browse_exec = QPushButton("...")
        browse_exec.clicked.connect(self.browse_exec)
        exec_row.addWidget(self.exec_path)
        exec_row.addWidget(browse_exec)
        layout.addLayout(exec_row)

        # Icon + browse (inline)
        icon_row = QHBoxLayout()
        self.icon_path = QLineEdit(); self.icon_path.setPlaceholderText("Icon Path (optional)")
        browse_icon = QPushButton("...")
        browse_icon.clicked.connect(self.browse_icon)
        icon_row.addWidget(self.icon_path)
        icon_row.addWidget(browse_icon)
        layout.addLayout(icon_row)

        # Description
        self.desc = QLineEdit(); self.desc.setPlaceholderText("Comment / Description (optional)")
        layout.addWidget(self.desc)

        # Terminal checkbox
        self.terminal = QCheckBox("Run in Terminal")
        layout.addWidget(self.terminal)

        # Categories dropdown
        self.category = QComboBox()
        self.category.addItems(CATEGORIES)
        layout.addWidget(QLabel("Category"))
        layout.addWidget(self.category)

        # Save folder + browse (inline)
        save_row = QHBoxLayout()
        self.save_path = QLineEdit(); self.save_path.setPlaceholderText("Save Folder (~/.local/share/applications)")
        browse_save = QPushButton("...")
        browse_save.clicked.connect(self.browse_save)
        save_row.addWidget(self.save_path)
        save_row.addWidget(browse_save)
        layout.addLayout(save_row)

        # Create button
        create_btn = QPushButton("Create .desktop")
        create_btn.clicked.connect(self.create_file)
        layout.addWidget(create_btn)

        self.setLayout(layout)

        browse_exec.setFixedWidth(30)
        browse_icon.setFixedWidth(30)
        browse_save.setFixedWidth(30)


    def browse_exec(self):
        file, _ = QFileDialog.getOpenFileName(self, "Select Executable")
        if file: self.exec_path.setText(file)

    def browse_icon(self):
        file, _ = QFileDialog.getOpenFileName(self, "Select Icon")
        if file: self.icon_path.setText(file)

    def browse_save(self):
        folder = QFileDialog.getExistingDirectory(self, "Select Folder")
        if folder: self.save_path.setText(folder)

    def create_file(self):
        n, e, d, s, cat, term, icon = (
            self.name.text(),
            self.exec_path.text(),
            self.desc.text(),
            self.save_path.text(),
            self.category.currentText(),
            self.terminal.isChecked(),
            self.icon_path.text()
        )

        if not n or not e or not s:
            QMessageBox.warning(self, "Error", "Name, Exec path, and Save folder are required!")
            return

        s = os.path.expanduser(s)
        os.makedirs(s, exist_ok=True)  # ensure folder exists
        path = os.path.join(s, f"{n}.desktop")

        with open(path, "w") as f:
            f.write("[Desktop Entry]\n")
            f.write(f"Name={n}\n")
            f.write(f"Exec={e}\n")
            f.write(f"Type=Application\n")
            if d: f.write(f"Comment={d}\n")
            if icon: f.write(f"Icon={icon}\n")
            f.write(f"Terminal={'true' if term else 'false'}\n")
            f.write(f"Categories={cat};\n")

        os.chmod(path, 0o755)
        QMessageBox.information(self, "Done", f"{path} created!")

if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = DesktopGenerator()
    win.show()
    sys.exit(app.exec())
